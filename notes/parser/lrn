CurrentOperation currentOperation  // Current operation.

Parser parser = new_parser()

State
  int steps[1000]
  int pgm_index
  int opn_index
  int opd_index


== Edit Keys ==

void edit_lrn() = MODE_EVAL

void edit_sst()
  pgm_index < 999: pgm_index += 1
  else: MODE_EVAL

void edit_bst() = pgm_index > 0: pgm_index -= 1

void edit_ins()
  for i = 999; i >= pgm_index + 1; i--: steps[i] = steps[i - 1]
  steps[pgm_index] = 0

void edit_del()
  for i = pgm_index; i < 999; i++: steps[i] = steps[i + 1]
  steps[999] = 0


== Helper functions ==

void key(int key)
  steps[pgm_index] = key
  pgm_index == 999:
    MODE_EVAL
  else:
    pgm_index += 1

void rub() = steps[pgm_index - 1] = 0

bool is_inv() = return parser.operations.last.operator.inv

void eval_operand(Operator opn, int opd_index)
  opr = opn.operator
  opd = opn.operands[opd_index]
  type = opd.type
  value = opd.value
  case type:
    LBL: D: DD: key(value)
    IND:
      opd_index == 0 && opr has synthesized ind:
        rub()
        key(synthesized_key)
      lse:
        key(Ind)
      value >= 0:
        key(value)
    DDD:
      assert(value >= 0)
      key(value / 100)
      key(value % 100)

bool next()
  opn = parser.operations[opn_index]
  opd_index < opn.operands.length - 1:
    opd_index += 1
    return true
  opn_index < parser.operations.length - 1:
    opn_index += 1
    opd_index = -1
    return true
  return false

bool has_next()
  opn = parser.operations[opn_index]
  return opn_index < opn.operands.length - 1 ||
         opd_index < parser.operations.last.operands.length - 1


== Implementation ==

void on_key_pressed(int i, int j):
  keyHandled = parser.handle_key_pressed(MODE_LRN, i, j)

  // Evaluate pending operands.
  while has_next():
    opd_index > 0:
      opn = parser.operations[opn_index]
      eval_operand(opn, opd_index)
    next()

  key = keyHandled.key
  context = keyHandled.context

  case context:
    KEY_EVL_SST: DBL_OPD_DD: DBL_OPD_DDD:
      assert(false)
    KEY_MOD_SEC: KEY_MOD_NOSEC:
      // Maybe change colors.
      return
    KEY_OPD_LBL: KEY_OPD_D: KEY_OPD_DD: KEY_OPD_DDD:
    KEY_OPD_IND: KEY_OPD_NOIND:
      // Pending operands.
      return
    KEY_SKIP: KEY_LBL_BEG: KEY_LBL_END: KEY_PGM_SBR:
    KEY_OPR_INV: KEY_OPR_NOINV:
      key(key)
    KEY_OPR_KEY:
      key == LRN: edit_lrn()
      key == SST: edit_sst()
      key == BST: edit_bst()
      key == Ins: edit_ins()
      key == Del: edit_del()
      key == SBR && is_inv() && steps[pgm_index - 1] == INV:
        rub()
        key(RTN)
      else:
        key(key)
